
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥ä½œç´€éŒ„è¡¨ï¼ˆå«æœå°‹ / åŒ¯å‡º / æ—¥æ›†ï¼‰</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h2 { color: #2c3e50; text-align: center; }
    .tab-section, .search-export-bar { text-align: center; margin-bottom: 15px; }
    .tab-buttons button {
      padding: 8px 16px; margin: 4px 3px;
      background: #3498db; color: #fff;
      border: none; border-radius: 4px; cursor: pointer;
    }
    .tab-buttons button.active { background: #2980b9; }
    .tab-add input { padding: 6px; width: 150px; }
    .tab-add button {
      padding: 6px 10px; margin-left: 5px;
      background: #2ecc71; color: #fff;
      border: none; border-radius: 4px;
    }
    .tab-buttons .tab-wrap { display: inline-block; margin: 3px; }
    .tab-buttons .tab-wrap span {
      background: #e74c3c; color: #fff;
      border-radius: 50%; padding: 2px 6px;
      font-size: 12px; cursor: pointer; margin-left: 5px;
    }
    table { width: 100%; border-collapse: collapse; background: #fff; font-size: 0.95em; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eaeaea; }
    td[contenteditable="true"] { background: #fdfdfd; }
    .add-task, .calendar-toggle { text-align: center; margin-top: 10px; }
    .add-btn, .calendar-btn, .export-btn {
      padding: 8px 16px; background: #2ecc71; color: #fff;
      border: none; border-radius: 4px; cursor: pointer;
    }
    .calendar-btn { background: #9b59b6; margin-left: 10px; }
    .export-btn { background: #f39c12; margin-left: 10px; }
    .delete-btn {
      background: #e74c3c; color: #fff; border: none;
      padding: 4px 8px; border-radius: 4px; cursor: pointer;
    }
    input[type="date"], input[type="text"] { padding: 5px; }
    #calendar { display: none; margin-top: 20px; }
    @media screen and (max-width: 600px) {
      table, thead, tbody, th, td, tr { display: block; width: 100%; }
      tr { margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; background: #fff; }
      th { display: none; }
      td { text-align: left; padding: 10px; border: none; border-bottom: 1px solid #eee; }
    }
  </style>
</head>
<body>

<h2>å·¥ä½œç´€éŒ„è¡¨ï¼ˆæœå°‹ + åŒ¯å‡º + æ—¥æ›†ï¼‰</h2>

<div class="tab-section">
  <div class="tab-buttons" id="tabs"></div>
  <div class="tab-add">
    <input type="text" id="newTabName" placeholder="è¼¸å…¥ä»»å‹™åç¨±" />
    <button onclick="createNewTab()">æ–°å¢ä»»å‹™åˆ†é </button>
  </div>
</div>

<div class="search-export-bar">
  ğŸ” <input type="text" id="searchBox" oninput="renderTable()" placeholder="æœå°‹ä»»å‹™ / å®Œæˆäº‹é …" />
  <button class="export-btn" onclick="exportCSV()">åŒ¯å‡ºç•¶å‰åˆ†é  CSV</button>
  <button class="calendar-btn" onclick="toggleCalendar()">ğŸ“… ç¸½æ—¥æ›†æª¢è¦–</button>
</div>

<table id="taskTable">
  <thead>
    <tr>
      <th>ä»»å‹™åç¨±</th>
      <th>è² è²¬äºº</th>
      <th>æ—¥æœŸ</th>
      <th>å®Œæˆäº‹é …</th>
      <th>åˆªé™¤</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="add-task">
  <button class="add-btn" onclick="addTask()">â• æ–°å¢ç´€éŒ„</button>
</div>

<div id="calendar"></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.js"></script>
<script>
  let currentTab = "";
  let taskData = {};

  function switchTab(tabName) {
    currentTab = tabName;
    renderTabs();
    renderTable();
    document.getElementById("taskTable").style.display = "table";
    document.getElementById("calendar").style.display = "none";
  }

  function createNewTab() {
    const name = document.getElementById("newTabName").value.trim();
    if (!name) return alert("è«‹è¼¸å…¥ä»»å‹™åç¨±");
    if (taskData[name]) return alert("é€™å€‹ä»»å‹™å·²ç¶“å­˜åœ¨ï¼");
    taskData[name] = [];
    saveData();
    renderTabs();
    switchTab(name);
    document.getElementById("newTabName").value = "";
  }

  function deleteTab(tabName) {
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤åˆ†é ã€Œ${tabName}ã€åŠå…¶æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ`)) return;
    delete taskData[tabName];
    saveData();
    const tabs = Object.keys(taskData);
    if (tabs.length === 0) taskData["ä»»å‹™ä¸€"] = [];
    renderTabs();
    switchTab(Object.keys(taskData)[0]);
  }

  function addTask(task = '', owner = '', date = '', note = '') {
    taskData[currentTab].push({ task, owner, date, note });
    saveData();
    renderTable();
  }

  function deleteTask(index) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ")) return;
    taskData[currentTab].splice(index, 1);
    saveData();
    renderTable();
  }

  function renderTabs() {
    const tabsDiv = document.getElementById("tabs");
    tabsDiv.innerHTML = "";
    Object.keys(taskData).forEach(tab => {
      const wrap = document.createElement("div");
      wrap.className = "tab-wrap";
      const btn = document.createElement("button");
      btn.textContent = tab;
      btn.onclick = () => switchTab(tab);
      if (tab === currentTab) btn.classList.add("active");
      const del = document.createElement("span");
      del.textContent = "Ã—";
      del.title = "åˆªé™¤åˆ†é ";
      del.onclick = () => deleteTab(tab);
      wrap.appendChild(btn);
      wrap.appendChild(del);
      tabsDiv.appendChild(wrap);
    });
  }

  function renderTable() {
    const keyword = document.getElementById("searchBox").value.toLowerCase();
    const tbody = document.querySelector("#taskTable tbody");
    tbody.innerHTML = "";
    const records = taskData[currentTab] || [];
    records.forEach((rec, index) => {
      if (
        rec.task.toLowerCase().includes(keyword) ||
        rec.note.toLowerCase().includes(keyword)
      ) {
        const row = tbody.insertRow();
        const c1 = row.insertCell(0);
        const c2 = row.insertCell(1);
        const c3 = row.insertCell(2);
        const c4 = row.insertCell(3);
        const c5 = row.insertCell(4);

        c1.contentEditable = "true"; c1.innerText = rec.task;
        c1.oninput = () => updateRecord(index, "task", c1.innerText);

        c2.contentEditable = "true"; c2.innerText = rec.owner;
        c2.oninput = () => updateRecord(index, "owner", c2.innerText);

        const dateInput = document.createElement("input");
        dateInput.type = "date";
        dateInput.value = rec.date;
        dateInput.onchange = () => updateRecord(index, "date", dateInput.value);
        c3.appendChild(dateInput);

        c4.contentEditable = "true"; c4.innerText = rec.note;
        c4.oninput = () => updateRecord(index, "note", c4.innerText);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.textContent = "åˆªé™¤";
        deleteBtn.onclick = () => deleteTask(index);
        c5.appendChild(deleteBtn);
      }
    });
  }

  function updateRecord(index, field, value) {
    taskData[currentTab][index][field] = value;
    saveData();
  }

  function saveData() {
    localStorage.setItem("pagedWorkRecordsCustom", JSON.stringify(taskData));
  }

  function exportCSV() {
    const records = taskData[currentTab] || [];
    let csv = "ä»»å‹™åç¨±,è² è²¬äºº,æ—¥æœŸ,å®Œæˆäº‹é …\n";
    records.forEach(rec => {
      csv += `${rec.task},${rec.owner},${rec.date},${rec.note}\n`;
    });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = currentTab + "-ç´€éŒ„.csv";
    link.click();
  }

  function toggleCalendar() {
    const cal = document.getElementById("calendar");
    const table = document.getElementById("taskTable");
    if (cal.style.display === "none") {
      table.style.display = "none";
      cal.style.display = "block";
      showCalendar();
    } else {
      table.style.display = "table";
      cal.style.display = "none";
    }
  }

  function showCalendar() {
    const allRecords = [];
    for (const tab in taskData) {
      taskData[tab].forEach((rec, i) => {
        if (rec.date)
          allRecords.push({
            title: `${tab} - ${rec.task}`,
            start: rec.date,
            description: rec.note
          });
      });
    }
    const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
      initialView: "dayGridMonth",
      height: 550,
      events: allRecords
    });
    calendar.render();
  }

  function loadData() {
    taskData = JSON.parse(localStorage.getItem("pagedWorkRecordsCustom") || "{}");
    if (Object.keys(taskData).length === 0) taskData["ä»»å‹™ä¸€"] = [];
    renderTabs();
    switchTab(Object.keys(taskData)[0]);
  }

  window.onload = loadData;
</script>

</body>
</html>
